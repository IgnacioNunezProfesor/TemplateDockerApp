# Configuración principal del servidor Apache HTTP
# Versión específica para contenedores Docker con PHP

# ServerTokens: Controla la información mostrada en headers de respuesta
# OS: muestra solo sistema operativo (Apache/2.4.57 (Unix))
ServerTokens OS
# ServerRoot: Directorio base de instalación del servidor
ServerRoot /var/www
# Listen: Puerto y dirección donde Apache escucha conexiones
# Usa variable de entorno SERVER_PORT para flexibilidad
Listen ${SERVER_PORT}

# ===== CARGA DE MÓDULOS APACHE =====
# MPM (Multi-Processing Module): prefork para compatibilidad con PHP módulo
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so

# Módulos de autenticación (authn = authentication)
LoadModule authn_file_module modules/mod_authn_file.so # Autenticación basada en archivos
LoadModule authn_core_module modules/mod_authn_core.so # Funcionalidad core de autenticación

# Módulos de autorización (authz = authorization)
LoadModule authz_host_module modules/mod_authz_host.so # Control acceso por host
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so # Grupos desde archivos
LoadModule authz_user_module modules/mod_authz_user.so # Control acceso por usuario
LoadModule authz_core_module modules/mod_authz_core.so # Funcionalidad core de autorización

# Módulos varios
LoadModule access_compat_module modules/mod_access_compat.so # Compatibilidad con versiones anteriores
LoadModule auth_basic_module modules/mod_auth_basic.so # Autenticación básica HTTP
LoadModule reqtimeout_module modules/mod_reqtimeout.so # Timeout de peticiones
LoadModule filter_module modules/mod_filter.so # Filtrado de contenido
LoadModule mime_module modules/mod_mime.so # Asociación tipos MIME
LoadModule log_config_module modules/mod_log_config.so # Configuración de logs
LoadModule env_module modules/mod_env.so # Variables de entorno
LoadModule headers_module modules/mod_headers.so # Manipulación de headers HTTP
LoadModule setenvif_module modules/mod_setenvif.so # Set env basado en headers
LoadModule version_module modules/mod_version.so # Control de versión
LoadModule unixd_module modules/mod_unixd.so # Funciones específicas Unix

# Módulos de contenido y directorios
LoadModule autoindex_module modules/mod_autoindex.so # Listado automático de directorios
# Configuración condicional de módulos CGI
<IfModule !mpm_prefork_module>
	#LoadModule cgid_module modules/mod_cgid.so # Comentado: no se usa con prefork
</IfModule>
<IfModule mpm_prefork_module>
	#LoadModule cgi_module modules/mod_cgi.so # Comentado: configuración alternativa
</IfModule>
LoadModule dir_module modules/mod_dir.so # Directorio índice
LoadModule alias_module modules/mod_alias.so # Alias y redirecciones

LoadModule negotiation_module modules/mod_negotiation.so # Negociación de contenido

# ===== CONFIGURACIÓN DEL PROCESO =====
<IfModule unixd_module>
    # Usuario y grupo bajo el cual se ejecutan los procesos hijos
    User apache
    Group apache
</IfModule>

# Información del administrador del servidor
# ${SERVER_NAME} se sustituye desde variable de entorno
ServerAdmin you@${SERVER_NAME}
# ServerSignature: Incluye información del servidor en páginas de error
ServerSignature On
# ServerName: Nombre y puerto del servidor
ServerName ${SERVER_NAME}:${SERVER_PORT}

# ===== CONFIGURACIÓN DE DIRECTORIOS =====
<IfModule dir_module>
    # Archivos servidos cuando se accede a un directorio (en orden de prioridad)
    DirectoryIndex index.html index.php info.php
</IfModule>

# Protección de archivos ocultos (especialmente .htaccess)
<Files ".ht*">
    Require all denied
</Files>

# ===== CONFIGURACIÓN DE LOGS =====
# Archivo de log de errores
ErrorLog logs/error.log

# Nivel de logging: warn (solo advertencias y errores)
LogLevel warn

# Configuración de formatos de log
<IfModule log_config_module>
 # LogFormat: Define formatos personalizados para los logs
    # %h: dirección IP del cliente
    # %l: identidad remota (usualmente -)
    # %u: usuario autenticado
    # %t: fecha y hora
    # %r: primera línea de la petición
    # %>s: código de estado final
    # %b: tamaño de respuesta en bytes
    # %{Referer}i: cabecera Referer
    # %{User-Agent}i: cabecera User-Agent
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    # Formato común (más simple)
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    
    # Configuración para módulo logio (transferencias de entrada/salida)
    <IfModule logio_module>
      # You need to enable mod_logio.c to use %I and %O
      # Necesitas habilitar mod_logio.c para usar %I y %O
      # %I: bytes recibidos (incluyendo headers)
      # %O: bytes enviados (incluyendo headers)
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>
    
    # CustomLog: Archivo donde se escriben los logs con formato 'combined'
    CustomLog logs/access.log combined
</IfModule>

# ===== CONFIGURACIÓN CGI =====
<IfModule alias_module>
    # ScriptAlias: Directorio para scripts CGI
    ScriptAlias /cgi-bin/ "/var/www/localhost/cgi-bin/"

</IfModule>

# Configuración específica para módulo cgid (threaded servers)
<IfModule cgid_module>
    #
    # ScriptSock: On threaded servers, designate the path to the UNIX
    # socket used to communicate with the CGI daemon of mod_cgid.
    #
    #Scriptsock cgisock
</IfModule>

# Configuración del directorio CGI
<Directory "/var/www/localhost/cgi-bin">
    AllowOverride None # No permitir .htaccess
    Options None # Sin opciones especiales
    Require all granted # Acceso permitido a todos
</Directory>

# ===== CONFIGURACIÓN DE HEADERS =====
<IfModule headers_module>
    # Elimina cabecera Proxy temprano en el procesamiento
    # Seguridad: previene inyección de cabeceras Proxy
    RequestHeader unset Proxy early
</IfModule>

# ===== CONFIGURACIÓN MIME =====
<IfModule mime_module>
    # TypesConfig: Ubicación del archivo de tipos MIME
    TypesConfig /etc/apache2/mime.types

    # AddType: Agrega tipos MIME adicionales
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz

</IfModule>

# Configuración para detección automática de tipo MIME
<IfModule mime_magic_module>
    # MIMEMagicFile: Archivo con reglas para detectar tipos por contenido
    MIMEMagicFile /etc/apache2/magic
</IfModule>

# ===== INCLUSIÓN DE CONFIGURACIONES ADICIONALES =====
# IncludeOptional: Incluye todos los archivos .conf del directorio
# Esto permite configuraciones modulares (php.conf, ssl.conf, etc.)
IncludeOptional /etc/apache2/conf.d/*.conf
